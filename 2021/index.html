<html>

<head>
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
</head>

<body>
  <div id="bg" class="bg"></div>
  <div class="timeline">
  </div>

  <script>
    class EnlargedImage {
      constructor() {
        this.parent = document.createElement("div")
        this.parent.classList.add("fullscreen")
        document.body.appendChild(this.parent)
        this.parent.onclick = () => {
          this.parent.classList.remove("open")
        }

        this.image = document.createElement("img")
        this.parent.appendChild(this.image)
      }

      open(src) {
        this.image.src = src
        this.parent.classList.add("open")
      }
    }

    let box = new EnlargedImage()

    function enlargeImgage(path) {
      box.open(path)
    }

    async function loadData() {
      const response = await fetch('/WoWDatabaseEditor/2021/timeline.json');
      const data = await response.json();

      let cards = []

      let timeline = document.body.getElementsByClassName("timeline")[0]
      for (let d of data) {
        if (d.skipWeb) 
          continue
        let container = document.createElement("div")
        container.classList.add("container")
        let content = document.createElement("div")
        container.classList.add("content")
        container.appendChild(content)

        let header = document.createElement("h2")
        content.appendChild(header)
        header.innerText = d.date;

        for (let text of d.content) {
          if (text.startsWith("img:")) {
            let img = document.createElement("img")
            img.src = text.substr(4)
            content.appendChild(img)
          }
          else if (text.startsWith("link:"))
          {
            let a = document.createElement("a")
            let p = document.createElement("p")
            p.appendChild(a)
            a.href = text.split('|')[1]
            a.innerText = text.substr(5).split('|')[0]
            content.appendChild(p)
          }
          else {
            let p = document.createElement("p")
            p.innerHTML = text
            content.appendChild(p)
          }
        }

        timeline.appendChild(container)
        cards.push({
          container: container,
          content: content,
          bg: d.bg
        })
      }

      let imgs = document.body.getElementsByTagName("img")
      for (let img of imgs) {
        img.style.cursor = "pointer"
        img.onclick = () => {
          enlargeImgage(img.src)
        }
      }

      let bg = document.getElementById("bg")
      document.addEventListener('scroll', function (e) {

        let any = false
        for (let card of cards) {
          let rect = card.container.getBoundingClientRect()
          if (rect.top < window.innerHeight) {
            card.container.classList.add("active")
            if (card.bg) {
              bg.style.backgroundImage = "url(" + card.bg + ")"
              bg.classList.add("shown")
              any = true
            }
          }
          else {
            card.container.classList.remove("active")
          }
        }
        if (!any) {
          bg.classList.remove("shown")
        }

      });
    }

    document.body.onload = () => {
      loadData();
    }
  </script>
</body>

</html>